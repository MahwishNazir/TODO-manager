# Data Model: JWT Authentication

**Feature Branch**: `003-jwt-auth`
**Created**: 2026-01-12
**Status**: Draft
**Related Documents**: [spec.md](./spec.md), [research.md](./research.md)

---

## Overview

This document defines the data entities, relationships, and validation rules for JWT-based authentication in the TODO application. The authentication system uses Better Auth for user management on the frontend and JWT token verification on the FastAPI backend.

**Key Design Principles**:
- **Minimal Schema Changes**: No new database tables required - reuse existing Task schema with user_id column
- **Stateless Backend**: JWT tokens are transient (not stored in database), validated per-request
- **User Isolation**: All task queries automatically filtered by JWT user_id claim
- **Standards Compliance**: RFC 7519 JWT structure with standard claims

---

## Entity Definitions

### 1. User Entity

**Managed By**: Better Auth (Next.js frontend)
**Storage**: PostgreSQL users table (created and managed by Better Auth)
**Purpose**: Represents authenticated users who can create and manage tasks

#### Schema Definition

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    email_verified BOOLEAN DEFAULT FALSE
);

-- Indexes
CREATE UNIQUE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
```

#### Field Definitions

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID | PRIMARY KEY, NOT NULL | Unique user identifier (maps to JWT `sub` claim) |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | User email address (login identifier) |
| `password_hash` | VARCHAR(255) | NOT NULL | Bcrypt hashed password (managed by Better Auth) |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW | Account creation timestamp |
| `updated_at` | TIMESTAMP | NOT NULL, DEFAULT NOW | Last account modification timestamp |
| `email_verified` | BOOLEAN | NOT NULL, DEFAULT FALSE | Email verification status (not used in Phase 2) |

#### Validation Rules

**Email Validation**:
- Format: RFC 5322 compliant email address
- Uniqueness: Must be unique across all users (enforced by database constraint)
- Case Handling: Normalized to lowercase by Better Auth
- Example Valid: `user@example.com`, `john.doe+tag@company.co.uk`
- Example Invalid: `invalid-email`, `@example.com`, `user@`

**Password Validation**:
- Minimum Length: 8 characters (enforced by Better Auth)
- Hashing Algorithm: bcrypt with cost factor 10 (managed by Better Auth)
- Storage: Only hashed version stored, never plaintext
- Validation performed during registration and login

**UUID Generation**:
- Format: RFC 4122 UUID v4 (random)
- Generated by PostgreSQL `gen_random_uuid()` function
- Immutable after creation

#### Relationships

**User → Tasks** (One-to-Many):
- One user can have many tasks
- Foreign key: `tasks.user_id` references `users.id`
- Cascade: Not defined (users table managed by Better Auth, deletion handled separately)
- Enforcement: Application-level via JWT validation

#### State Transitions

Users table is managed entirely by Better Auth. No explicit state machine.

**Account Lifecycle** (managed by Better Auth):
1. **Registration**: User provides email + password → Better Auth creates user record
2. **Login**: User provides credentials → Better Auth validates and issues JWT
3. **Active Session**: User has valid JWT token (checked per-request)
4. **Token Expiration**: JWT expires after 1 hour → User must refresh or re-login
5. **Logout**: Frontend clears JWT token (backend remains stateless)

---

### 2. JWT Token Entity

**Managed By**: Better Auth (issuance) + PyJWT (verification)
**Storage**: Transient (frontend only - HttpOnly cookies + sessionStorage)
**Purpose**: Stateless authentication credential for API access

#### Token Structure

JWT tokens follow RFC 7519 standard with three components:

```text
{HEADER}.{PAYLOAD}.{SIGNATURE}
```

**Example Token**:
```text
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMTIzIiwiZW1haWwiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNzA0MDY3MjAwLCJleHAiOjE3MDQwNzA4MDAsImlzcyI6InRvZG8tYXBwIiwiYXVkIjoidG9kby1hcGkifQ.signature-hash-here
```

#### Field Definitions (Claims)

**Header** (Base64-encoded JSON):
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

**Payload** (Base64-encoded JSON with claims):

| Claim | Type | Required | Description | Validated By |
|-------|------|----------|-------------|--------------|
| `sub` | String (UUID) | Yes | Subject - User ID from users.id | PyJWT + App Logic |
| `email` | String | Yes | User email address | Not validated (informational) |
| `iat` | Number (Unix timestamp) | Yes | Issued At - Token creation time | PyJWT |
| `exp` | Number (Unix timestamp) | Yes | Expiration - Token expiry time (iat + 1 hour) | PyJWT |
| `iss` | String | Yes | Issuer - Must be "todo-app" | PyJWT |
| `aud` | String | Yes | Audience - Must be "todo-api" | PyJWT |

**Payload Example**:
```json
{
  "sub": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "email": "user@example.com",
  "iat": 1704067200,
  "exp": 1704070800,
  "iss": "todo-app",
  "aud": "todo-api"
}
```

**Signature** (HMAC-SHA256):
```text
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  BETTER_AUTH_SECRET
)
```

#### Validation Rules

**Signature Verification**:
- Algorithm: HS256 (HMAC with SHA-256)
- Secret Key: Shared `BETTER_AUTH_SECRET` environment variable (minimum 32 characters)
- Validation: PyJWT verifies signature matches payload using shared secret
- Rejection: Invalid signature results in HTTP 401 Unauthorized

**Expiration Validation**:
- Token lifetime: 1 hour (3600 seconds) from issuance
- Validation: Current time must be less than `exp` claim
- Clock Skew Tolerance: 10 seconds leeway for time synchronization
- Rejection: Expired tokens result in HTTP 401 with "Token expired" message

**Issuer/Audience Validation**:
- Issuer (`iss`): Must exactly match "todo-app"
- Audience (`aud`): Must exactly match "todo-api"
- Purpose: Prevents token reuse across different services/environments
- Rejection: Mismatched claims result in HTTP 401

**Required Claims Validation**:
- Claims `sub`, `iat`, `exp` must be present in payload
- Missing claims result in HTTP 401 with "Malformed token" message

**User ID Extraction**:
- Extract `sub` claim from verified token payload
- Format: UUID string matching users.id column
- Used for all database queries to enforce user isolation

#### Token Lifecycle

```text
┌─────────────────────────────────────────────────────────────────┐
│                        TOKEN LIFECYCLE                          │
└─────────────────────────────────────────────────────────────────┘

1. ISSUANCE (Better Auth on Next.js)
   User Login → Better Auth validates credentials
              → Generates JWT with user_id in 'sub' claim
              → Sets HttpOnly cookie + returns token to frontend
              → Token stored in sessionStorage

2. USAGE (FastAPI Backend)
   API Request → Frontend includes "Authorization: Bearer {token}"
               → Backend extracts token from header
               → PyJWT verifies signature, expiration, claims
               → Extract user_id from 'sub' claim
               → Execute query with user_id filter

3. REFRESH (Better Auth)
   Token expires in <5 min → Frontend calls Better Auth refresh
                           → Better Auth issues new JWT with updated exp
                           → Frontend updates token in storage

4. EXPIRATION
   Token expires (1 hour) → Next API request fails with 401
                          → Frontend attempts refresh
                          → If refresh fails, redirect to login

5. LOGOUT
   User clicks logout → Frontend calls Better Auth signOut
                     → Better Auth clears cookies
                     → Frontend clears sessionStorage
                     → User redirected to login page
```

#### Storage Strategy

**Frontend Storage** (Dual Strategy):

1. **HttpOnly Cookies** (Primary - Managed by Better Auth):
   - Cookie Name: `auth_session`
   - Attributes: `HttpOnly; Secure; SameSite=Lax; Max-Age=3600`
   - Security: Protected from XSS attacks (JavaScript cannot access)
   - Purpose: Authenticates user with Better Auth for refresh operations

2. **sessionStorage** (Cache - Managed by Frontend):
   - Key: `jwt_token`
   - Value: JWT access token string
   - Security: Vulnerable to XSS (cleared on tab close)
   - Purpose: Fast access for Authorization headers

**Backend Storage**: None (stateless design)
- No token database table
- No revocation list
- No session state
- Each request validated independently

#### Token Size

- **Typical Size**: 350-400 bytes (Base64 encoded)
- **Header**: ~30 bytes
- **Payload**: ~200-250 bytes (6 claims + user data)
- **Signature**: ~43 bytes (HS256)
- **HTTP Header**: `Authorization: Bearer {token}` = ~410 bytes total
- **Impact**: Negligible network overhead (<0.5KB per request)

---

### 3. Task Entity (Modified for Authentication)

**Managed By**: FastAPI Backend
**Storage**: PostgreSQL tasks table (existing schema from Step 1)
**Purpose**: User's todo items with automatic user isolation via JWT

#### Schema Definition

```sql
-- Existing schema from Step 1 (no changes required)
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL,
    title VARCHAR(500) NOT NULL,
    is_completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, is_completed);
```

#### Field Definitions

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | INTEGER | PRIMARY KEY, AUTO INCREMENT | Unique task identifier |
| `user_id` | VARCHAR(50) | NOT NULL, INDEXED | User identifier (matches JWT `sub` claim) |
| `title` | VARCHAR(500) | NOT NULL, 1-500 chars | Task description |
| `is_completed` | BOOLEAN | NOT NULL, DEFAULT FALSE | Task completion status |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT NOW | Task creation timestamp |
| `updated_at` | TIMESTAMP | NOT NULL, DEFAULT NOW | Last modification timestamp |

#### Authentication Integration

**User Isolation Enforcement**:

1. **JWT Validation** (Middleware):
   ```python
   # Automatic per-request validation
   user_id = get_current_user_id(credentials)  # Extracts from JWT 'sub' claim
   ```

2. **Query Filtering** (Service Layer):
   ```python
   # All queries automatically scoped to authenticated user
   tasks = db.query(Task).filter(Task.user_id == user_id).all()
   ```

3. **Create Operations**:
   ```python
   # user_id automatically set from JWT (not from request body)
   task = Task(user_id=user_id, title=task_data.title)
   ```

4. **Update/Delete Operations**:
   ```python
   # Query first checks user_id match (404 if not owned by user)
   task = db.query(Task).filter(Task.id == task_id, Task.user_id == user_id).first()
   ```

#### Security Validation Rules

**User ID Validation**:
- Source: JWT `sub` claim (verified by PyJWT signature validation)
- Format: UUID string (matches users.id format)
- Trust: Backend trusts user_id from verified JWT without database lookup
- Enforcement: All database queries include `WHERE user_id = {jwt_user_id}`

**Task Access Rules**:
- Users can ONLY access tasks where `task.user_id == jwt.sub`
- Attempts to access other users' tasks return HTTP 404 (not 403 to avoid leaking existence)
- User ID NEVER accepted from request body or path parameters (only from JWT)

**Task Creation**:
- User ID automatically set from JWT `sub` claim
- Frontend cannot override user_id (ignored if provided)
- Validates title length (1-500 characters) before insertion

**Task Updates**:
- Only task owner (user_id matches JWT sub) can update task
- Update timestamp automatically refreshed on modification
- Partial updates supported (PATCH) for title and is_completed fields

**Task Deletion**:
- Only task owner can delete task
- Soft delete not implemented (hard delete in Phase 2)
- Returns HTTP 204 No Content on success, 404 if not found or not owned

#### Relationships

**Tasks → User** (Many-to-One):
- Foreign key relationship (not enforced at database level in Phase 2)
- Logical reference: `tasks.user_id` matches `users.id` (verified via JWT)
- No explicit foreign key constraint (Better Auth manages users table independently)
- Orphaned tasks: Not handled in Phase 2 (user deletion out of scope)

---

## Entity Relationship Diagram

```text
┌─────────────────────────────────────────────────────────────────┐
│                   ENTITY RELATIONSHIPS                          │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│       USERS          │  (Managed by Better Auth)
├──────────────────────┤
│ id (UUID) PK         │
│ email UNIQUE         │
│ password_hash        │
│ created_at           │
│ updated_at           │
└──────────────────────┘
         │ 1
         │
         │ issues
         │
         ▼
┌──────────────────────┐
│    JWT TOKEN         │  (Transient - Not Stored)
├──────────────────────┤
│ sub (user_id)        │
│ email                │
│ iat                  │
│ exp                  │
│ iss                  │
│ aud                  │
└──────────────────────┘
         │
         │ authenticates
         │
         ▼
┌──────────────────────┐
│       TASKS          │  (Managed by FastAPI)
├──────────────────────┤
│ id INTEGER PK        │
│ user_id VARCHAR FK   │◄─┐
│ title VARCHAR        │   │ References (logical, not enforced)
│ is_completed BOOL    │   │
│ created_at TIMESTAMP │   │
│ updated_at TIMESTAMP │   │
└──────────────────────┘   │
         │                 │
         └─────────────────┘
              * (many)
```

**Key Relationships**:

1. **User → JWT Token** (1:N)
   - One user can have multiple valid JWT tokens (multi-device login)
   - Tokens issued by Better Auth on each login/refresh
   - No database tracking (stateless design)

2. **JWT Token → Task Access** (Transient)
   - JWT token contains user_id in `sub` claim
   - Backend extracts user_id for database queries
   - No direct storage relationship (token not persisted)

3. **User → Tasks** (1:N)
   - One user owns many tasks
   - Enforced via JWT user_id matching tasks.user_id
   - No foreign key constraint (logical relationship only)

---

## Data Flow: Authentication to Task Access

```text
┌─────────────────────────────────────────────────────────────────┐
│             AUTHENTICATION DATA FLOW                            │
└─────────────────────────────────────────────────────────────────┘

1. USER REGISTRATION
   ┌──────────┐  POST /api/auth/register         ┌──────────────┐
   │ Frontend │  email + password                 │ Better Auth  │
   │          ├──────────────────────────────────►│              │
   │ (Next.js)│                                    │ (Next.js)    │
   └──────────┘  ◄────────────────────────────────┤              │
                 Success confirmation              └───────┬──────┘
                                                          │
                                                          ▼
                                                   ┌──────────────┐
                                                   │   Users DB   │
                                                   │ (PostgreSQL) │
                                                   └──────────────┘

2. USER LOGIN + JWT ISSUANCE
   ┌──────────┐  POST /api/auth/login             ┌──────────────┐
   │ Frontend │  email + password                 │ Better Auth  │
   │          ├──────────────────────────────────►│              │
   │          │                                    │ Validates    │
   │          │  ◄─────────────────────────────────┤ credentials  │
   │          │  JWT token (HttpOnly cookie)      └───────┬──────┘
   └────┬─────┘  + token in response body                │
        │                                                 ▼
        │                                          ┌──────────────┐
        │                                          │   Users DB   │
        │                                          └──────────────┘
        ▼
   Store token in
   sessionStorage

3. AUTHENTICATED API REQUEST
   ┌──────────┐  GET /api/v1/tasks                ┌──────────────┐
   │ Frontend │  Authorization: Bearer {token}    │   FastAPI    │
   │          ├──────────────────────────────────►│              │
   │          │                                    │ 1. Extract   │
   │          │                                    │    token     │
   │          │                                    │ 2. Verify    │
   │          │                                    │    signature │
   │          │                                    │ 3. Check exp │
   │          │                                    │ 4. Extract   │
   │          │                                    │    user_id   │
   │          │                                    └───────┬──────┘
   │          │                                            │
   │          │                                            ▼
   │          │                                    ┌──────────────┐
   │          │                                    │   Tasks DB   │
   │          │                                    │ WHERE        │
   │          │                                    │ user_id =    │
   │          │  ◄─────────────────────────────────┤ {jwt.sub}    │
   │          │  200 OK + tasks array             └──────────────┘
   └──────────┘

4. TOKEN EXPIRATION + REFRESH
   ┌──────────┐  Check exp < 5min?                ┌──────────────┐
   │ Frontend │  Yes → POST /api/auth/refresh     │ Better Auth  │
   │          ├──────────────────────────────────►│              │
   │          │  (HttpOnly cookie auto-sent)      │ Issues new   │
   │          │  ◄─────────────────────────────────┤ JWT token    │
   │          │  New JWT with updated exp         └──────────────┘
   └────┬─────┘
        │
        ▼
   Update token in
   sessionStorage
```

---

## Migration Notes

**No Database Migrations Required for Phase 2**:

1. **Users Table**:
   - Created and managed automatically by Better Auth
   - Better Auth handles schema migrations internally
   - No manual migration needed

2. **Tasks Table**:
   - Already exists from Phase II Step 1 (REST API implementation)
   - `user_id` column already present (VARCHAR(50), indexed)
   - Schema is forward-compatible with JWT authentication
   - No changes needed to existing schema

3. **No New Tables**:
   - No tokens table (stateless design)
   - No sessions table (JWT replaces sessions)
   - No refresh_tokens table (Better Auth manages internally)

**Configuration Changes Only**:
- Add `JWT_SECRET` / `BETTER_AUTH_SECRET` to environment variables
- Configure Better Auth in Next.js (`lib/auth.ts`)
- Add JWT verification middleware to FastAPI (`src/api/dependencies.py`)

---

## Validation Rules Summary

### User Entity Validation

| Field | Rule | Error Message |
|-------|------|---------------|
| email | Must match RFC 5322 email format | "Invalid email format" |
| email | Must be unique in users table | "Email already registered" |
| password | Minimum 8 characters | "Password must be at least 8 characters" |
| password | Bcrypt hashed before storage | N/A (internal) |

### JWT Token Validation

| Claim | Rule | Error Response |
|-------|------|----------------|
| signature | Must match HMAC-SHA256(header.payload, secret) | HTTP 401 "Invalid authentication token" |
| exp | Must be greater than current time (with 10s leeway) | HTTP 401 "Token has expired" |
| iat | Must not be in future (with 10s leeway) | HTTP 401 "Invalid token timestamp" |
| iss | Must equal "todo-app" | HTTP 401 "Invalid token issuer" |
| aud | Must equal "todo-api" | HTTP 401 "Invalid token audience" |
| sub | Must be present and non-empty | HTTP 401 "Missing user ID in token" |

### Task Entity Validation

| Field | Rule | Error Response |
|-------|------|----------------|
| user_id | Must match JWT sub claim | HTTP 404 "Task not found" (if mismatch) |
| title | 1-500 characters | HTTP 422 "Title must be 1-500 characters" |
| is_completed | Must be boolean | HTTP 422 "Invalid completion status" |

---

## Security Considerations

### Data Protection

1. **Password Security**:
   - Passwords hashed with bcrypt (cost factor 10)
   - Never stored in plaintext
   - Never returned in API responses
   - Better Auth handles all password operations

2. **Token Security**:
   - JWT payload is Base64-encoded (NOT encrypted)
   - Never include sensitive data (passwords, API keys) in JWT
   - Only include user_id, email, and standard claims
   - Signature ensures payload integrity

3. **User ID Security**:
   - User ID extracted from verified JWT signature
   - Backend never trusts user_id from request body/parameters
   - All database queries scoped to authenticated user_id

### Privacy Considerations

1. **Email Privacy**:
   - Email stored in users table and JWT payload
   - Not exposed in public APIs (only in authenticated user context)
   - Consider hashing for analytics/logging

2. **Task Privacy**:
   - Tasks accessible only by owner (via user_id isolation)
   - 404 responses for unauthorized access (don't leak existence)
   - No cross-user task visibility

3. **Token Exposure**:
   - Tokens transmitted via HTTPS only in production
   - HttpOnly cookies prevent XSS token theft
   - Short 1-hour lifetime limits theft impact

---

## Performance Considerations

### Database Query Performance

**User Queries**:
- Unique index on `users.email` enables fast login lookups (O(log n))
- User validation occurs once during login (not per-request)

**Task Queries**:
- Composite index on `(user_id, is_completed)` optimizes filtering
- All task queries include `WHERE user_id = {jwt.sub}` (indexed)
- Expected query time: <5ms for typical user task counts (<1000 tasks)

**JWT Validation**:
- Stateless validation requires zero database queries
- HS256 signature verification: <5ms on modern hardware
- No session table lookups required

### Token Size Impact

- JWT size: ~400 bytes per request (Authorization header)
- Negligible network overhead (<0.5KB)
- No pagination issues with reasonable task counts

### Caching Strategy

- sessionStorage caches JWT token (eliminates Better Auth API call per request)
- No backend caching needed (stateless validation)
- Task queries can be cached client-side (invalidate on mutations)

---

## Testing Data Models

### Test User Accounts

```sql
-- Development test users (passwords: "password123")
INSERT INTO users (id, email, password_hash, created_at, updated_at) VALUES
('a1b2c3d4-e5f6-7890-1234-567890abcdef', 'alice@example.com', '$2b$10$...', NOW(), NOW()),
('b2c3d4e5-f6a7-8901-2345-678901bcdefg', 'bob@example.com', '$2b$10$...', NOW(), NOW());
```

### Test JWT Tokens

```python
# Generate test token for unit tests
import jwt
from datetime import datetime, timedelta, timezone

def create_test_token(user_id: str, exp_minutes: int = 60) -> str:
    now = datetime.now(timezone.utc)
    payload = {
        "sub": user_id,
        "email": "test@example.com",
        "iat": now,
        "exp": now + timedelta(minutes=exp_minutes),
        "iss": "todo-app",
        "aud": "todo-api",
    }
    return jwt.encode(payload, "test-secret-key", algorithm="HS256")
```

### Test Tasks

```sql
-- Test tasks for alice@example.com
INSERT INTO tasks (user_id, title, is_completed, created_at, updated_at) VALUES
('a1b2c3d4-e5f6-7890-1234-567890abcdef', 'Test Task 1', false, NOW(), NOW()),
('a1b2c3d4-e5f6-7890-1234-567890abcdef', 'Test Task 2', true, NOW(), NOW());

-- Test tasks for bob@example.com (should not be visible to alice)
INSERT INTO tasks (user_id, title, is_completed, created_at, updated_at) VALUES
('b2c3d4e5-f6a7-8901-2345-678901bcdefg', 'Bob Task 1', false, NOW(), NOW());
```

---

## References

- [Better Auth Documentation - JWT Plugin](https://www.better-auth.com/docs/plugins/jwt)
- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)
- [PyJWT Documentation](https://pyjwt.readthedocs.io/)
- [FastAPI Security - OAuth2 with Password and Bearer](https://fastapi.tiangolo.com/tutorial/security/oauth2-jwt/)

---

## Revision History

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2026-01-12 | 1.0.0 | Initial data model documentation | Claude Code Agent |
